# 版本管理

Schema Element Editor 提供完善的版本管理功能，包括编辑历史、草稿保存和版本对比。

## 编辑历史

### 功能概述

编辑历史会自动记录您在编辑器中的每次变更，方便回退到之前的版本。

<!-- screenshot: 历史记录下拉菜单 -->

### 记录策略

| 触发条件    | 版本类型 | 标记 |
| ----------- | -------- | ---- |
| 打开抽屉    | 初始加载 | 📄   |
| 编辑后 2 秒 | 自动保存 | ✏️   |
| 点击保存    | 保存版本 | 💾   |
| 加载草稿    | 草稿版本 | 📝   |
| 应用收藏    | 收藏版本 | ⭐   |
| 切换历史    | 历史切换 | 🔄   |

### 使用方法

1. 点击工具栏的「历史」下拉按钮
2. 查看版本列表
3. 点击任意版本恢复到该状态

<!-- screenshot: 点击历史版本恢复的操作 -->

### 版本列表说明

- **时间戳** - 版本创建时间
- **类型图标** - 标识版本类型
- **当前版本** - ✓ 标记 + 高亮背景
- **特殊版本** - 不同图标区分

### 存储策略

| 存储位置     | sessionStorage                  |
| ------------ | ------------------------------- |
| 作用域       | 按元素参数（paramsKey）分别存储 |
| 普通版本上限 | 可配置（默认 50 条）            |
| 特殊版本     | 不计入上限                      |
| 生命周期     | 关闭标签页后清除                |

### 清除历史

点击历史菜单中的「清除历史」按钮：

- 清除所有历史记录
- 保留当前版本作为新的初始记录

## 草稿功能

### 功能概述

草稿功能帮助您保存编辑中的内容，防止意外丢失。

### 手动保存草稿

1. 编辑内容
2. 点击工具栏的「草稿」按钮
3. 选择「保存草稿」

<!-- screenshot: 草稿菜单 -->

### 加载草稿

1. 点击「草稿」按钮
2. 选择「加载草稿」
3. 确认加载（会覆盖当前内容）

### 自动保存草稿

启用后，编辑器内容变化时会自动保存草稿。

**配置方法**：

1. 打开配置页面
2. 找到「数据管理」→「草稿配置」
3. 开启「草稿自动保存」

<!-- screenshot: 自动保存配置 -->

### 删除草稿

1. 点击「草稿」按钮
2. 选择「删除草稿」

### 草稿存储

| 存储位置 | Chrome 扩展存储（chrome.storage） |
| -------- | --------------------------------- |
| 作用域   | 按元素参数分别存储                |
| 生命周期 | 持久保存，直到手动删除            |

## Diff 对比

### 功能概述

Diff 对比功能让您可以比较两个版本之间的差异。

<!-- screenshot: Diff 对比界面 -->

### 进入 Diff 模式

1. 点击工具栏的「Diff」按钮
2. 选择要对比的基准版本

### 对比选项

| 对比对象       | 说明                         |
| -------------- | ---------------------------- |
| **与原始数据** | 对比当前内容与最初加载的数据 |
| **与历史版本** | 选择任意历史版本进行对比     |

### 对比模式

Schema Element Editor 支持三种对比模式：

#### 原始模式

直接比较 JSON 字符串，包括格式差异。

```diff
- {"name": "old"}
+ {"name": "new"}
```

#### 反序列化模式

解析 JSON 后比较，忽略格式差异（如空格、换行）。

适用于关注内容变化而非格式变化。

#### AST 模式

以 AST 结构进行语义级比较。

适用于 Elements[] 类型数据，能更准确地识别结构变化。

### Diff 显示

| 颜色        | 含义       |
| ----------- | ---------- |
| 🟢 绿色背景 | 新增的内容 |
| 🔴 红色背景 | 删除的内容 |

<!-- screenshot: Diff 结果显示 -->

### 退出 Diff 模式

点击「退出 Diff」按钮或关闭 Diff 面板。

## 配置选项

### 历史记录配置

在「数据管理」→「历史记录配置」中设置：

| 配置项       | 说明                   | 默认值 |
| ------------ | ---------------------- | ------ |
| 历史记录上限 | 普通版本的最大保存数量 | 50 条  |

> 💡 特殊版本（保存、草稿、收藏）不计入上限。

### 草稿配置

在「数据管理」→「草稿配置」中设置：

| 配置项       | 说明                   | 默认值 |
| ------------ | ---------------------- | ------ |
| 草稿自动保存 | 内容变化时自动保存草稿 | 关闭   |

## 功能开关

在「功能开关」→「功能模块」中可以开启或关闭：

| 功能     | 说明                                       |
| -------- | ------------------------------------------ |
| 草稿功能 | 包含保存草稿、加载草稿、删除草稿、自动保存 |
| 历史记录 | 包含编辑历史记录和版本切换                 |

<!-- screenshot: 功能开关配置 -->

## 使用技巧

### 误操作恢复

1. 发现误操作后立即点击「历史」
2. 找到误操作前的版本
3. 点击恢复

### 实验性编辑

1. 开启前先保存草稿
2. 进行实验性修改
3. 不满意则加载草稿恢复

### 对比修改效果

1. 进行修改
2. 使用 Diff 与原始数据对比
3. 确认修改符合预期后保存

### 多版本比较

1. 开启录制模式进行操作
2. 停止录制后查看版本列表
3. 选择任意两个版本进行 Diff

## 故障排除

### 历史记录丢失

**原因**：历史记录存储在 sessionStorage，关闭标签页后会清除

**预防措施**：

- 重要内容及时保存到页面
- 使用草稿功能持久保存

### 草稿加载失败

**可能原因**：

1. 草稿已被删除
2. 存储配额已满

**解决方案**：

1. 清理不需要的草稿
2. 检查 Chrome 扩展存储配额

### Diff 结果难以理解

**建议**：

1. 尝试切换对比模式
2. 对于 Elements[] 数据使用 AST 模式
3. 对于格式变化多的数据使用反序列化模式
