# Schema Editor

ä¸€ä¸ªå¼ºå¤§çš„Chromeæ‰©å±•ç¨‹åºï¼Œç”¨äºæŸ¥çœ‹å’Œç¼–è¾‘DOMå…ƒç´ çš„Schemaæ•°æ®ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¯ **å…ƒç´ æ£€æµ‹**ï¼šæŒ‰ä½ Alt/Option é”®æ‚¬åœæ—¶è‡ªåŠ¨æ£€æµ‹å…ƒç´ çš„ `data-chat-msg-id` å’Œ `data-opener-component-id` å±æ€§
- ğŸ¨ **å¯è§†åŒ–é«˜äº®**ï¼šç”¨å‹å¥½çš„æ ·å¼æ ‡è®°ç›®æ ‡å…ƒç´ 
- ğŸ“ **Schemaç¼–è¾‘**ï¼šå†…ç½®ä»£ç ç¼–è¾‘å™¨ç¼–è¾‘JSON Schema
- ğŸ’¾ **ä¸€é”®æ›´æ–°**ï¼šä¿®æ”¹åç›´æ¥æ›´æ–°é¡µé¢Schema
- ğŸ”„ **æ ¼å¼åŒ–å·¥å…·**ï¼šå†…ç½®JSONæ ¼å¼åŒ–å’Œæ ¡éªŒåŠŸèƒ½
- ğŸ›ï¸ **çŠ¶æ€æŒä¹…åŒ–**ï¼šè®°ä½æ¿€æ´»çŠ¶æ€å’Œåå¥½è®¾ç½®
- ğŸ›¡ï¸ **é˜²è¯¯è§¦è®¾è®¡**ï¼šä»…åœ¨æŒ‰ä½ Alt/Option é”®æ—¶å¯ç”¨æ£€æµ‹åŠŸèƒ½

## æŠ€æœ¯æ ˆ

- React 18 + TypeScript
- Vite + CRXJS
- Ant Design 5.x
- Monaco Editor (æœ¬åœ°æ‰“åŒ…)
- Styled Components
- Chrome Extension Manifest V3

## å¼€å‘æŒ‡å—

### å‰ç½®è¦æ±‚

- Node.js >= 16
- npm æˆ– tnpm

### å®‰è£…ä¾èµ–

```bash
tnpm install
```

### å¼€å‘æ¨¡å¼

```bash
tnpm run dev
```

å¼€å‘æ¨¡å¼ä¼šå¯åŠ¨Viteå¼€å‘æœåŠ¡å™¨ï¼Œå¹¶åœ¨ `dist` ç›®å½•ç”Ÿæˆæ‰©å±•æ–‡ä»¶ã€‚

### æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
tnpm run build
```

æ„å»ºå®Œæˆåï¼Œäº§ç‰©å°†è¾“å‡ºåˆ° `dist` ç›®å½•ã€‚

### æ‰“åŒ…åˆ†å‘

```bash
npm run package
```

æ­¤å‘½ä»¤ä¼šï¼š
1. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
2. åˆ›å»º zip å®‰è£…åŒ…
3. è¾“å‡ºåˆ° `releases/` ç›®å½•

è¯¦ç»†åˆ†å‘è¯´æ˜è¯·æŸ¥çœ‹ [DISTRIBUTION.md](./DISTRIBUTION.md)

### åŠ è½½åˆ°Chromeï¼ˆå¼€å‘æ¨¡å¼ï¼‰

1. æ‰“å¼€Chromeæµè§ˆå™¨
2. è®¿é—® `chrome://extensions/`
3. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
4. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
5. é€‰æ‹©é¡¹ç›®çš„ `dist` ç›®å½•

### å®‰è£…åˆ°Chromeï¼ˆç”¨æˆ·æ¨¡å¼ï¼‰

å¦‚æœä½ åªæ˜¯æƒ³ä½¿ç”¨æ’ä»¶è€Œä¸æ˜¯å¼€å‘ï¼Œè¯·æŸ¥çœ‹ [INSTALL.md](./INSTALL.md) è·å–å®‰è£…æŒ‡å—ã€‚

## ä½¿ç”¨è¯´æ˜

### æ¿€æ´»æ’ä»¶

1. ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„Schema Editorå›¾æ ‡
2. å›¾æ ‡çŠ¶æ€å˜åŒ–ï¼š
   - **æ¿€æ´»æ—¶**ï¼šå›¾æ ‡æ˜¾ç¤º ğŸŸ¢ **ç»¿è‰²**å¹½çµ
   - **åœç”¨æ—¶**ï¼šå›¾æ ‡æ˜¾ç¤º âš« **ç°è‰²**å¹½çµ
   - æ ‡é¢˜æ˜¾ç¤ºï¼š`Schema Editor - å·²æ¿€æ´» âœ“` æˆ– `Schema Editor - æœªæ¿€æ´»`

### æ£€æŸ¥å…ƒç´ 

1. æ¿€æ´»æ’ä»¶åï¼Œ**æŒ‰ä½ Alt é”®ï¼ˆMac ä½¿ç”¨ Option âŒ¥ é”®ï¼‰**
2. å°†é¼ æ ‡æ‚¬åœåœ¨é¡µé¢å…ƒç´ ä¸Š
3. å¦‚æœå…ƒç´ æœ‰ç›®æ ‡å±æ€§ï¼Œä¼šæ˜¾ç¤ºé«˜äº®è¾¹æ¡†å’Œå±æ€§å€¼
4. å¦‚æœå…ƒç´ æ²¡æœ‰ç›®æ ‡å±æ€§ï¼Œä¼šæ˜¾ç¤º"éæ³•ç›®æ ‡"æç¤º
5. é‡Šæ”¾ Alt/Option é”®åï¼Œé«˜äº®å’Œæç¤ºä¼šç«‹å³æ¶ˆå¤±

> ğŸ’¡ **ä¸ºä»€ä¹ˆéœ€è¦æŒ‰ä½ Alt/Option é”®ï¼Ÿ**  
> é¿å…æ­£å¸¸æµè§ˆé¡µé¢æ—¶è¯¯è§¦æ’ä»¶çš„é«˜äº®åŠŸèƒ½ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚Mac ä¸Š Control+å•å‡»ä¼šè§¦å‘å³é”®èœå•ï¼Œæ‰€ä»¥ä½¿ç”¨ Alt/Option é”®æ›´åˆé€‚ã€‚

### ç¼–è¾‘Schema

1. **æŒ‰ä½ Alt/Option é”®å¹¶ç‚¹å‡»**é«˜äº®çš„å…ƒç´ 
2. å³ä¾§æŠ½å±‰ä¼šè‡ªåŠ¨æ‰“å¼€ï¼Œæ˜¾ç¤ºå…ƒç´ çš„Schemaæ•°æ®
3. åœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘JSON
4. ä½¿ç”¨"æ ¼å¼åŒ–"æŒ‰é’®ç¾åŒ–JSON
5. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®æ›´æ–°Schema

### åœç”¨æ’ä»¶

å†æ¬¡ç‚¹å‡»å·¥å…·æ å›¾æ ‡å³å¯åœç”¨æ’ä»¶ã€‚

## é¡µé¢é›†æˆè¦æ±‚

æ’ä»¶éœ€è¦é¡µé¢æä¾›ä»¥ä¸‹å…¨å±€æ–¹æ³•ï¼š

### `window.__getSchemaById(chatMsgId, openerComponentId)`

```typescript
/**
 * è·å–å…ƒç´ çš„Schemaæ•°æ®
 * @param chatMsgId - èŠå¤©æ¶ˆæ¯IDï¼ˆæ¥è‡ªå…ƒç´ çš„ data-chat-msg-id å±æ€§ï¼‰
 * @param openerComponentId - æ‰“å¼€ç»„ä»¶IDï¼ˆæ¥è‡ªå…ƒç´ çš„ data-opener-component-id å±æ€§ï¼‰
 * @returns Schemaå¯¹è±¡
 */
window.__getSchemaById = (chatMsgId, openerComponentId) => {
  // æ ¹æ®IDè¿”å›å¯¹åº”çš„Schemaå¯¹è±¡
  return {
    // ä½ çš„Schemaæ•°æ®
  }
}
```

### `window.__updateSchemaById(schema, chatMsgId, openerComponentId)`

```typescript
/**
 * æ›´æ–°å…ƒç´ çš„Schemaæ•°æ®
 * @param schema - æ–°çš„Schemaå¯¹è±¡
 * @param chatMsgId - èŠå¤©æ¶ˆæ¯ID
 * @param openerComponentId - æ‰“å¼€ç»„ä»¶ID
 * @returns æ˜¯å¦æ›´æ–°æˆåŠŸï¼ˆè¿”å›trueè¡¨ç¤ºæˆåŠŸï¼‰
 */
window.__updateSchemaById = (schema, chatMsgId, openerComponentId) => {
  // æ›´æ–°Schemaæ•°æ®
  // ... ä½ çš„æ›´æ–°é€»è¾‘
  return true // è¿”å›trueè¡¨ç¤ºæ›´æ–°æˆåŠŸ
}
```

### å…ƒç´ æ ‡è®°æ–¹å¼

**âš ï¸ é‡è¦ï¼šå…ƒç´ å¿…é¡»åŒæ—¶å…·æœ‰ä¸¤ä¸ªå±æ€§æ‰ä¼šè¢«è¯†åˆ«ä¸ºæœ‰æ•ˆå…ƒç´ **

åœ¨HTMLå…ƒç´ ä¸Šæ·»åŠ  data å±æ€§ï¼š

```html
<!-- âœ… æ­£ç¡®ï¼šåŒæ—¶åŒ…å«ä¸¤ä¸ªå±æ€§ -->
<div data-chat-msg-id="msg-001" data-opener-component-id="comp-001">
  å†…å®¹
</div>

<!-- âŒ é”™è¯¯ï¼šåªæœ‰chatMsgIdï¼ˆä¼šè¢«æ ‡è®°ä¸º"éæ³•ç›®æ ‡"ï¼‰-->
<div data-chat-msg-id="msg-001">å†…å®¹</div>

<!-- âŒ é”™è¯¯ï¼šåªæœ‰openerComponentIdï¼ˆä¼šè¢«æ ‡è®°ä¸º"éæ³•ç›®æ ‡"ï¼‰-->
<div data-opener-component-id="comp-001">å†…å®¹</div>
```

## é¡¹ç›®ç»“æ„

```
ChromeTools/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ manifest.json          # Chromeæ‰©å±•é…ç½®
â”‚   â”œâ”€â”€ background/            # Background Service Worker
â”‚   â”‚   â””â”€â”€ service-worker.ts
â”‚   â”œâ”€â”€ content/               # Content Scripts
â”‚   â”‚   â”œâ”€â”€ index.tsx          # å…¥å£æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ monitor.ts         # å…ƒç´ ç›‘å¬å™¨
â”‚   â”‚   â”œâ”€â”€ injected-script.ts # é¡µé¢æ³¨å…¥è„šæœ¬
â”‚   â”‚   â””â”€â”€ ui/                # React UIç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ App.tsx
â”‚   â”‚       â”œâ”€â”€ SchemaDrawer.tsx
â”‚   â”‚       â”œâ”€â”€ Tooltip.tsx
â”‚   â”‚       â””â”€â”€ styles.ts
â”‚   â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ message.ts
â”‚   â”‚   â”œâ”€â”€ storage.ts
â”‚   â”‚   â””â”€â”€ element-detector.ts
â”‚   â””â”€â”€ types/                 # TypeScriptç±»å‹å®šä¹‰
â”‚       â””â”€â”€ index.ts
â”œâ”€â”€ public/
â”‚   â””â”€â”€ icons/                 # æ‰©å±•å›¾æ ‡
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json
```

## æ¶æ„è¯´æ˜

### é€šä¿¡æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»å›¾æ ‡
  â†“
Background Service Workeråˆ‡æ¢çŠ¶æ€
  â†“
é€šçŸ¥Content Script
  â†“
Content Scriptå¼€å§‹ç›‘å¬æŒ‰é”®å’Œhover
  â†“
ç”¨æˆ·æŒ‰ä½Alt/Optioné”® + hoverå…ƒç´  â†’ æ˜¾ç¤ºé«˜äº®å’Œtooltip
  â†“
ç”¨æˆ·æŒ‰ä½Alt/Optioné”® + ç‚¹å‡»å…ƒç´ 
  â†“
æ‡’åŠ è½½React UIï¼ˆé¦–æ¬¡ï¼‰
  â†“
Injected Scriptè°ƒç”¨window.__getSchemaById()
  â†“
ç¼–è¾‘å™¨å±•ç¤ºJSON
  â†“
ç”¨æˆ·ç¼–è¾‘å¹¶ä¿å­˜
  â†“
Injected Scriptè°ƒç”¨window.__updateSchemaById()
  â†“
Ant Design Messageæ˜¾ç¤ºç»“æœ
```

### æ ·å¼éš”ç¦»

ä½¿ç”¨Shadow DOMæŠ€æœ¯å®ç°å®Œå…¨çš„æ ·å¼éš”ç¦»ï¼Œç¡®ä¿æ’ä»¶UIä¸å—é¡µé¢æ ·å¼å½±å“ï¼Œä¹Ÿä¸å½±å“é¡µé¢æ ·å¼ã€‚

### æ€§èƒ½ä¼˜åŒ–

- åˆ†å±‚åŠ è½½ï¼šåŸºç¡€ç›‘å¬å™¨å§‹ç»ˆè½»é‡ï¼ŒReact UIæ‡’åŠ è½½
- Shadow DOMï¼šé¿å…æ ·å¼è®¡ç®—å¼€é”€
- äº‹ä»¶å§”æ‰˜ï¼šé«˜æ•ˆçš„äº‹ä»¶ç›‘å¬æœºåˆ¶

## æ³¨æ„äº‹é¡¹

1. æ’ä»¶å›¾æ ‡é‡‡ç”¨å¯çˆ±å¹½çµä¸»é¢˜ï¼Œé€šè¿‡é¢œè‰²åŒºåˆ†çŠ¶æ€ï¼ˆç»¿è‰²=æ¿€æ´»ï¼Œç°è‰²=æœªæ¿€æ´»ï¼‰
2. é¡µé¢å¿…é¡»æä¾› `window.__getSchemaById` å’Œ `window.__updateSchemaById` æ–¹æ³•
3. **âš ï¸ ç›®æ ‡å…ƒç´ å¿…é¡»åŒæ—¶å…·æœ‰ `data-chat-msg-id` å’Œ `data-opener-component-id` ä¸¤ä¸ªå±æ€§**ï¼ˆHTML dataå±æ€§ï¼‰
4. æ’ä»¶é€šè¿‡è¯»å–HTML dataå±æ€§æ¥è¯†åˆ«å…ƒç´ ï¼Œè€Œä¸æ˜¯JavaScriptå¯¹è±¡å±æ€§
5. åªæœ‰ä¸€ä¸ªå±æ€§çš„å…ƒç´ ä¼šè¢«æ ‡è®°ä¸º"éæ³•ç›®æ ‡"ï¼Œæ— æ³•æ‰“å¼€ç¼–è¾‘å™¨

## è®¸å¯è¯

MIT
